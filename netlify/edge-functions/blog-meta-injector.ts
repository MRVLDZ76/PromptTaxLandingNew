// @ts-nocheck

// Inline blog metadata to avoid TypeScript import issues in edge runtime
const blogPostsMetadata: Record<string, any> = {
  'crypto-tax-nightmare-solved-2025': {
    title: 'Crypto Tax Nightmare Solved: AI-Powered Tax Prep Saves 40+ Hours',
    excerpt: 'If you\'ve traded crypto in 2025, you know crypto taxes are a nightmare. Multiple exchanges, thousands of transactions, DeFi protocols - and the IRS expects perfect accuracy. Learn how AI automation can save you 40+ hours.',
    author: 'Prompt Tax Team',
    date: '2025-01-15',
    seo: {
      description: 'Discover how AI-powered tax automation solves the crypto tax nightmare. Save 40+ hours on tax prep with intelligent crypto transaction processing for 2025.',
      keywords: ['crypto tax', 'crypto tax software', 'AI tax automation', 'cryptocurrency taxes 2025', 'crypto tax prep'],
      ogImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/crypto-blog-og-1200x630.jpg',
      linkedInImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/crypto-blog-linkedin-1200x627.jpg',
      twitterImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/crypto-blog-twitter-1200x675.jpg'
    }
  },
  'ai-k1-generator-partnership-tax-revolution': {
    title: 'AI K-1 Generator: The Partnership Tax Revolution CPAs Have Been Waiting For',
    excerpt: 'Partnership K-1 forms are notoriously complex and time-consuming. Discover how AI-powered K-1 generation is revolutionizing partnership tax preparation for CPAs and tax professionals.',
    author: 'Prompt Tax Team',
    date: '2025-01-10',
    seo: {
      description: 'AI-powered K-1 generator revolutionizes partnership tax preparation. Automate complex K-1 form processing and save hours on partnership tax returns.',
      keywords: ['K-1 generator', 'AI K-1', 'partnership tax', 'K-1 automation', 'tax software for CPAs'],
      ogImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/k1-generator-og-1200x630.jpg',
      linkedInImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/k1-generator-linkedin-1200x627.jpg',
      twitterImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/k1-generator-twitter-1200x675.jpg'
    }
  },
  'simplify-k1-form-processing-crypto-tax-season': {
    title: 'How to Simplify K-1 Form Processing During Crypto Tax Season',
    excerpt: 'K-1 forms meet crypto taxes: the ultimate complexity challenge. Learn practical strategies to streamline K-1 processing when dealing with cryptocurrency partnerships and investments.',
    author: 'Prompt Tax Team',
    date: '2025-01-05',
    seo: {
      description: 'Master K-1 form processing for crypto tax season. Practical strategies and AI tools to simplify complex partnership tax returns involving cryptocurrency.',
      keywords: ['K-1 processing', 'crypto K-1', 'partnership crypto taxes', 'tax season automation'],
      ogImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/k1-crypto-og-1200x630.jpg',
      linkedInImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/k1-blog-linkedin-1200x627.jpg',
      twitterImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/k1-crypto-twitter-1200x675.jpg'
    }
  },
  'crypto-tax-ai-automation-saves-15-hours': {
    title: 'Crypto Tax AI Automation: How We Saved 15+ Hours Per Client',
    excerpt: 'Real-world case study: How AI automation transformed our crypto tax workflow, reducing preparation time from 18 hours to just 3 hours per client while improving accuracy.',
    author: 'Prompt Tax Team',
    date: '2024-12-28',
    seo: {
      description: 'Case study: How AI automation reduced crypto tax preparation time by 15+ hours per client while improving accuracy and compliance.',
      keywords: ['crypto tax automation', 'AI tax case study', 'tax efficiency', 'crypto tax workflow'],
      ogImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/crypto-blog-og-1200x630.jpg',
      linkedInImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/crypto-blog-linkedin-1200x627.jpg',
      twitterImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/crypto-blog-twitter-1200x675.jpg'
    }
  },
  'costly-tax-filing-errors-cpa-review-saves-thousands': {
    title: '7 Costly Tax Filing Errors (And How a CPA Review Can Save You Thousands)',
    excerpt: 'Discover the 7 most expensive tax filing errors that cost taxpayers thousands. Learn how professional CPA review catches mistakes before filing and saves you money.',
    author: 'Prompt Tax Team',
    date: '2025-01-20',
    seo: {
      description: 'Discover the 7 most expensive tax filing errors that cost taxpayers thousands. Learn how professional CPA review catches mistakes before filing. Get expert tax review from $179.',
      keywords: ['tax filing errors', 'CPA tax review', 'tax return mistakes', 'professional tax review', 'crypto tax errors', 'K-1 form review', 'e-filing services', 'tax preparation help'],
      ogImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/cpa-review-og-1200x630.jpg',
      linkedInImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/cpa-review-linkedin-1200x627.jpg',
      twitterImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/cpa-review-twitter-1200x675.jpg'
    }
  },
  'crypto-tax-complete-guide-2025': {
    title: 'Crypto Tax Made Simple: Complete Guide to Filing Bitcoin, NFTs & DeFi in 2025',
    excerpt: 'File crypto taxes in minutes, not weeks. Automatic import from 500+ exchanges. Handle Bitcoin, Ethereum, NFTs, DeFi, staking & airdrops. CPA review included from $149.',
    author: 'Prompt Tax Team',
    date: '2025-01-25',
    seo: {
      description: 'File crypto taxes in minutes, not weeks. Automatic import from 500+ exchanges. Handle Bitcoin, Ethereum, NFTs, DeFi, staking & airdrops. CPA review included. From $149.',
      keywords: ['crypto tax software', 'cryptocurrency tax filing', 'Bitcoin taxes', 'NFT tax reporting', 'DeFi taxes', 'crypto tax calculator', 'crypto CPA review', 'blockchain tax preparation', 'crypto tax forms'],
      ogImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/crypto-bundle-og-1200x630.jpg',
      linkedInImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/crypto-bundle-linkedin-1200x627.jpg',
      twitterImage: 'https://businessesppall.nyc3.cdn.digitaloceanspaces.com/prompttax/logos/og/crypto-bundle-twitter-1200x675.jpg'
    }
  }
};

export default async (request: Request, context: any) => {
  const url = new URL(request.url);
  const pathname = url.pathname;

  // Only process blog post URLs
  if (!pathname.startsWith('/blog/')) {
    return context.next();
  }

  // Extract slug from URL (e.g., /blog/costly-tax-filing-errors-cpa-review-saves-thousands)
  const slug = pathname.replace('/blog/', '').replace(/\/$/, ''); // Remove trailing slash
  
  // Skip if it's the blog index or other non-post pages
  if (!slug || slug === 'grid' || slug === 'list' || slug === 'single') {
    return context.next();
  }

  // Get blog post metadata
  const post = blogPostsMetadata[slug];
  
  if (!post) {
    // If post not found, let the app handle it
    return context.next();
  }

  // Get the original HTML response
  const response = await context.next();
  const html = await response.text();

  // Build the dynamic meta tags
  const siteUrl = url.origin;
  const canonicalUrl = `${siteUrl}/blog/${slug}`;
  const description = post.seo?.description || post.excerpt;
  const ogImage = post.seo?.ogImage || `${siteUrl}/images/default-og.jpg`;
  const linkedInImage = post.seo?.linkedInImage || post.seo?.ogImage || ogImage;
  const twitterImage = post.seo?.twitterImage || post.seo?.ogImage || ogImage;
  const keywords = post.seo?.keywords ? (Array.isArray(post.seo.keywords) ? post.seo.keywords.join(', ') : post.seo.keywords) : '';
  const publishedTime = new Date(post.date).toISOString();

  // Replace the default meta tags with blog-specific ones
  let updatedHtml = html;

  // Replace title (use global flag to catch all instances)
  updatedHtml = updatedHtml.replace(
    /<title>[^<]*<\/title>/g,
    `<title>${post.title} | Prompt Tax</title>`
  );

  // Replace name="title" meta tag
  updatedHtml = updatedHtml.replace(
    /<meta name="title" content="[^"]*"\s*\/?>/g,
    `<meta name="title" content="${post.title}">`
  );

  // Replace description
  updatedHtml = updatedHtml.replace(
    /<meta name="description" content="[^"]*"\s*\/?>/g,
    `<meta name="description" content="${description}">`
  );

  // Replace keywords if exists
  if (keywords) {
    updatedHtml = updatedHtml.replace(
      /<meta name="keywords" content="[^"]*"\s*\/?>/g,
      `<meta name="keywords" content="${keywords}">`
    );
  }

  // Replace canonical URL
  updatedHtml = updatedHtml.replace(
    /<link rel="canonical" href="[^"]*"\s*\/?>/g,
    `<link rel="canonical" href="${canonicalUrl}">`
  );

  // Replace Open Graph tags (use global flag)
  updatedHtml = updatedHtml.replace(
    /<meta property="og:type" content="[^"]*"\s*\/?>/g,
    `<meta property="og:type" content="article">`
  );

  updatedHtml = updatedHtml.replace(
    /<meta property="og:url" content="[^"]*"\s*\/?>/g,
    `<meta property="og:url" content="${canonicalUrl}">`
  );

  updatedHtml = updatedHtml.replace(
    /<meta property="og:title" content="[^"]*"\s*\/?>/g,
    `<meta property="og:title" content="${post.title}">`
  );

  updatedHtml = updatedHtml.replace(
    /<meta property="og:description" content="[^"]*"\s*\/?>/g,
    `<meta property="og:description" content="${description}">`
  );

  updatedHtml = updatedHtml.replace(
    /<meta property="og:image" content="[^"]*"\s*\/?>/g,
    `<meta property="og:image" content="${ogImage}">`
  );

  updatedHtml = updatedHtml.replace(
    /<meta property="og:image:secure_url" content="[^"]*"\s*\/?>/g,
    `<meta property="og:image:secure_url" content="${ogImage}">`
  );

  updatedHtml = updatedHtml.replace(
    /<meta property="og:image:alt" content="[^"]*"\s*\/?>/g,
    `<meta property="og:image:alt" content="${post.title}">`
  );

  // Add Facebook App ID if missing
  if (!updatedHtml.includes('fb:app_id')) {
    updatedHtml = updatedHtml.replace(
      /<meta property="og:site_name"/,
      `<meta property=\"fb:app_id\" content=\"1234567890\">\n  <meta property=\"og:site_name\"`
    );
  }

  // Add article-specific meta tags before the closing </head> tag
  const articleMetaTags = `
    <meta property="article:published_time" content="${publishedTime}">
    <meta property="article:modified_time" content="${publishedTime}">
    <meta property="article:author" content="${post.author}">
    ${post.tags ? post.tags.map(tag => `<meta property="article:tag" content="${tag}">`).join('\n    ') : ''}
  `;

  updatedHtml = updatedHtml.replace('</head>', `${articleMetaTags}</head>`);

  // Replace Twitter Card tags (use both name and property attributes)
  updatedHtml = updatedHtml.replace(
    /<meta (property|name)="twitter:url" content="[^"]*"\s*\/?>/g,
    `<meta property="twitter:url" content="${canonicalUrl}">`
  );

  updatedHtml = updatedHtml.replace(
    /<meta (property|name)="twitter:title" content="[^"]*"\s*\/?>/g,
    `<meta property="twitter:title" content="${post.title}">`
  );

  updatedHtml = updatedHtml.replace(
    /<meta (property|name)="twitter:description" content="[^"]*"\s*\/?>/g,
    `<meta property="twitter:description" content="${description}">`
  );

  updatedHtml = updatedHtml.replace(
    /<meta (property|name)="twitter:image" content="[^"]*"\s*\/?>/g,
    `<meta property="twitter:image" content="${twitterImage}">`
  );

  updatedHtml = updatedHtml.replace(
    /<meta (property|name)="twitter:image:alt" content="[^"]*"\s*\/?>/g,
    `<meta property="twitter:image:alt" content="${post.title}">`
  );

  // Return the modified HTML
  return new Response(updatedHtml, {
    headers: {
      "content-type": "text/html; charset=utf-8",
      "cache-control": "public, max-age=0, must-revalidate",
    },
  });
};

export const config = { path: "/blog/*" };
